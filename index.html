<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Kiểm Tra Tương Tác - Thầy Lê Nguyễn Cường</title>
    <style>
        :root {
            --primary-green: #2ecc71;
            --dark-green: #27ae60;
            --yellow-text: #f1c40f;
            --blue-text: #2980b9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }

        /* I.A - Yêu cầu tiêu đề */
        .header-title {
            text-align: center;
            background-color: var(--primary-green);
            color: var(--yellow-text);
            padding: 15px 30px;
            border: 4px solid var(--dark-green);
            border-radius: 15px;
            box-shadow: 0 8px 0 var(--dark-green), 0 15px 20px rgba(0,0,0,0.2);
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
            transform: perspective(500px) rotateX(5deg);
        }

        .teacher-name {
            color: var(--blue-text);
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* I.B.1 - Dòng 3: Các nút điều khiển */
        .control-panel {
            display: flex;
            gap: 15px;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-start { background-color: #3498db; color: white; }
        .btn-submit { background-color: #e74c3c; color: white; }
        .btn-reset { background-color: #95a5a6; color: white; }
        .btn-answer { background-color: #f39c12; color: white; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        .score-box {
            background: #eee;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #d35400;
        }

        .timer-box {
            font-family: 'Courier New', Courier, monospace;
            background: #2c3e50;
            color: #e74c3c;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
        }

        /* I.B.2 - Không gian câu hỏi có thanh cuộn */
        #quiz-container {
            width: 100%;
            max-width: 900px;
            height: 500px;
            overflow-y: auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: none; /* Hiện khi bấm Làm bài */
        }

        .question-item {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #eee;
        }

        .question-text {
            font-weight: bold;
            margin-bottom: 10px;
            color: #34495e;
        }

        .options-list {
            list-style: none;
            padding: 0;
        }

        .option-item {
            margin: 8px 0;
        }

        .fill-blank-input {
            border: none;
            border-bottom: 2px solid #3498db;
            outline: none;
            padding: 2px 10px;
            width: 150px;
            font-weight: bold;
            color: #2980b9;
        }

        /* Footer buttons */
        .footer-actions {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .correct-ans { color: #27ae60; font-weight: bold; margin-top: 5px; display: none; }
        
        sub { font-size: 0.8em; }

        /* Mobile responsive */
        @media (max-width: 600px) {
            .control-panel { flex-direction: column; align-items: stretch; }
            .header-title { font-size: 18px; }
        }
    </style>
</head>
<body>

    <div class="header-title">Bài Kiểm Tra Tương Tác - Tự nhiên và Xã hội – Lớp 3</div>
    <div class="teacher-name">Thầy Lê Nguyễn Cường</div>

    <div class="control-panel">
        <div class="input-group">
            <label>Họ tên:</label>
            <input type="text" id="studentName" placeholder="Nhập họ tên...">
        </div>
        <div class="input-group">
            <label>Lớp:</label>
            <input type="text" id="studentClass" placeholder="Nhập lớp...">
        </div>
        <button class="btn btn-start" id="btnStart" onclick="startQuiz()">Làm bài</button>
        <div class="input-group">
            <label>Điểm tổng:</label>
            <div class="score-box" id="totalScore">-</div>
        </div>
        <div class="timer-box" id="timer">150s</div>
    </div>

    <div id="quiz-container">
        <!-- Câu hỏi sẽ được render tại đây -->
    </div>

    <div class="footer-actions" id="actionButtons" style="display: none;">
        <button class="btn btn-submit" id="btnSubmit" onclick="submitQuiz()">Nộp bài</button>
        <button class="btn btn-reset" id="btnReset" onclick="resetQuiz()">Làm lại bài</button>
        <button class="btn btn-answer" id="btnAnswer" onclick="showAnswers()">Hiện đáp án</button>
    </div>

    <script>
        // C.1 - Khai báo Web App URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwJItr6AyewVBqL80fOuJw8UfaARiHLbhYkWyhbqvpLf5mfjjUdMcHuZjJjKmF50uloJw/exec";

        let timeLeft = 150;
        let timerInterval;
        let hasSubmitted = false;
        let canReset = true;

        const questions = [
            { id: 1, type: 'mc', q: 'Con người hô hấp chủ yếu bằng cơ quan nào?', options: ['Dạ dày', 'Tim', 'Phổi', 'Ruột'], ans: 'C' },
            { id: 2, type: 'mc', q: 'Việc làm nào sau đây giúp bảo vệ môi trường?', options: ['Vứt rác xuống sông', 'Bẻ cành cây', 'Đốt rác bừa bãi', 'Bỏ rác đúng nơi quy định'], ans: 'D' },
            { id: 3, type: 'mc', q: 'Gia đình là nơi:', options: ['Chỉ có ông bà', 'Chỉ có bố mẹ', 'Mọi người yêu thương và chăm sóc nhau', 'Chỉ để ăn và ngủ'], ans: 'C' },
            { id: 4, type: 'mc', q: 'Nước sạch có vai trò gì đối với con người?', options: ['Không cần thiết', 'Chỉ để tưới cây', 'Giúp con người sống và sinh hoạt hằng ngày', 'Chỉ dùng để tắm'], ans: 'C' },
            { id: 5, type: 'tf', q: 'Phát biểu sau đây là đúng hay sai: “Ăn nhiều rau xanh giúp cơ thể khỏe mạnh.”', options: ['Đúng', 'Sai'], ans: 'Đúng' },
            { id: 6, type: 'tf', q: 'Phát biểu sau đây là đúng hay sai: “Trẻ em không cần phải nghe lời ông bà, cha mẹ.”', options: ['Đúng', 'Sai'], ans: 'Sai' },
            { id: 7, type: 'fill', q: 'Điền từ thích hợp vào chỗ trống: “Con người cần __________ để thở và sống.”', ans: 'không khí' },
            { id: 8, type: 'fill', q: 'Điền từ thích hợp vào chỗ trống: “Mỗi người cần giữ __________ sạch sẽ để phòng tránh bệnh tật.”', ans: 'vệ sinh' }
        ];

        function renderQuestions() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, index) => {
                let html = `<div class="question-item" id="q-block-${index}">
                    <div class="question-text">Câu ${index + 1}. ${q.q}</div>`;
                
                if (q.type === 'mc' || q.type === 'tf') {
                    html += `<ul class="options-list">`;
                    q.options.forEach((opt, i) => {
                        const label = String.fromCharCode(65 + i);
                        const val = q.type === 'mc' ? label : opt;
                        html += `
                            <li class="option-item">
                                <label>
                                    <input type="radio" name="q${index}" value="${val}"> 
                                    ${q.type === 'mc' ? label + '. ' : ''}${opt}
                                </label>
                            </li>`;
                    });
                    html += `</ul>`;
                } else {
                    html += `<input type="text" class="fill-blank-input" id="q${index}" placeholder="...">`;
                }
                
                html += `<div class="correct-ans" id="ans-${index}">Đáp án đúng: ${q.ans}</div></div>`;
                container.innerHTML += html;
            });
        }

        function startQuiz() {
            const name = document.getElementById('studentName').value.trim();
            const lop = document.getElementById('studentClass').value.trim();

            if (!name || !lop) {
                alert("Vui lòng nhập đầy đủ Họ tên và Lớp trước khi làm bài!");
                return;
            }

            document.getElementById('studentName').disabled = true;
            document.getElementById('studentClass').disabled = true;
            document.getElementById('btnStart').disabled = true;
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex';

            renderQuestions();
            startTimer();
        }

        function startTimer() {
            timeLeft = 150;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft + 's';
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                }
            }, 1000);
        }

        async function submitQuiz() {
            if (hasSubmitted) {
                alert("Bạn đã nộp bài rồi!");
                return;
            }

            clearInterval(timerInterval);
            let correctCount = 0;
            const totalCount = questions.length;

            questions.forEach((q, index) => {
                let userAns = "";
                if (q.type === 'mc' || q.type === 'tf') {
                    const selected = document.querySelector(`input[name="q${index}"]:checked`);
                    userAns = selected ? selected.value : "";
                } else {
                    userAns = document.getElementById(`q${index}`).value.trim().toLowerCase();
                }

                if (userAns === q.ans || userAns === q.ans.toLowerCase()) {
                    correctCount++;
                }
            });

            // III.A.2 - Tính điểm thang 10
            const score = Math.round((correctCount * 10 / totalCount) * 10) / 10;
            document.getElementById('totalScore').innerText = score;

            hasSubmitted = true;
            document.getElementById('btnSubmit').disabled = true;

            // III.C - Gửi dữ liệu lên Google Sheet
            const payload = {
                hoTen: document.getElementById('studentName').value,
                lop: document.getElementById('studentClass').value,
                diem: score,
                soDung: correctCount,
                tongSoCau: totalCount
            };

            try {
                // Sử dụng fetch với no-cors theo yêu cầu
                fetch(WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                console.log("Dữ liệu đã được gửi.");
            } catch (error) {
                console.error("Lỗi khi gửi dữ liệu:", error);
            }
            
            alert(`Nộp bài thành công! Điểm của bạn là: ${score}`);
        }

        function resetQuiz() {
            if (!canReset) {
                alert("Bạn không thể làm lại sau khi đã xem đáp án!");
                return;
            }
            if (!confirm("Bạn có chắc chắn muốn làm lại từ đầu?")) return;

            hasSubmitted = false;
            document.getElementById('btnSubmit').disabled = false;
            document.getElementById('totalScore').innerText = "-";
            document.getElementById('studentName').disabled = false;
            document.getElementById('studentClass').disabled = false;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            clearInterval(timerInterval);
            document.getElementById('timer').innerText = '150s';
        }

        function showAnswers() {
            if (!hasSubmitted) {
                if(!confirm("Bạn chưa nộp bài. Xem đáp án ngay sẽ tính là nộp bài với điểm hiện tại. Tiếp tục?")) return;
                submitQuiz();
            }
            
            canReset = false;
            document.getElementById('btnReset').disabled = true;
            
            questions.forEach((q, index) => {
                document.getElementById(`ans-${index}`).style.display = 'block';
            });
            alert("Đã hiển thị đáp án. Bạn không thể làm lại bài này nữa.");
        }
    </script>
</body>
</html>